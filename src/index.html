<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Personal Info Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;600&family=Oxanium:wght@400;600&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .flip-digit {
        position: relative;
        width: 1ch;
        height: 1em;
        perspective: 600px;
      }
      .flip-inner {
        position: absolute;
        inset: 0;
        transform-style: preserve-3d;
        transition: transform 0.6s ease;
      }
      .flip-inner.flip {
        transform: rotateX(-180deg);
      }
      .flip-face {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        backface-visibility: hidden;
      }
      .flip-back {
        transform: rotateX(180deg);
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              ui: ["IBM Plex Sans", "sans-serif"],
              display: ["Oxanium", "sans-serif"],
            },
            colors: {
              panel: "#0a0a0a",
              panelBorder: "#1f1f1f",
              accent: "#20c997",
              dim: "#9aa0a6",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-black text-white font-ui min-h-screen">
    <div class="w-full max-w-none mx-auto px-8 py-4 h-[360px] aspect-[16/3]">
      <header class="mb-4 md:mb-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="bg-panel border border-panelBorder rounded-2xl p-5 flex items-center justify-between">
            <div>
              <p class="text-dim text-sm uppercase tracking-widest">Now</p>
              <p id="date" class="text-base leading-tight whitespace-nowrap"></p>
            </div>
            <div class="text-right">
              <div id="time" class="font-display text-4xl md:text-6xl tracking-wider flex items-center gap-2"></div>
              <p id="timezone" class="text-dim text-sm"></p>
            </div>
          </div>
          <div class="bg-panel border border-panelBorder rounded-2xl p-5 flex items-center justify-between">
            <div>
              <p class="text-dim text-sm uppercase tracking-widest">Weather</p>
              <div class="flex items-center gap-3 mt-2">
                <span id="weather-icon" class="text-4xl">--</span>
                <div>
                  <p id="weather-temp" class="font-display text-4xl">--¬∞C</p>
                  <p id="weather-desc" class="text-dim text-sm">--</p>
                </div>
              </div>
            </div>
            <div class="text-right text-sm">
              <p class="text-dim">Wind</p>
              <p id="weather-wind" class="font-display text-xl">-- km/h</p>
              <p id="location" class="text-dim text-xs mt-1">Tokyo</p>
            </div>
          </div>
        </div>
      </header>

      <main class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
        <section class="lg:col-span-2 bg-panel border border-panelBorder rounded-2xl p-5">
          <div class="flex items-center justify-between">
            <h2 class="font-display text-2xl">Weather Outlook</h2>
            <span class="text-dim text-sm">Open-Meteo</span>
          </div>
          <div class="mt-4 bg-black/60 rounded-xl p-4">
            <p class="text-dim text-sm">Next 12 Hours (3h)</p>
            <div id="forecast" class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm"></div>
          </div>
        </section>

        <section class="lg:col-span-3 bg-panel border border-panelBorder rounded-2xl p-5">
          <div class="flex items-center justify-between">
            <h2 class="font-display text-2xl">News</h2>
            <span class="text-dim text-sm">NHK Feed</span>
          </div>
          <div id="news-list" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>
      </main>
    </div>

    <script>
      const LOCATION = {
        // Â§©Ê∞ó„ÅÆÂèñÂæóÂ∫ßÊ®ôÔºàÂ§âÊõ¥ÂèØËÉΩÔºâ
        name: "Tokyo",
        latitude: 35.6895,
        longitude: 139.6917,
      };

      const WEATHER_ENDPOINT = (lat, lon) =>
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&hourly=temperature_2m,precipitation_probability,weather_code&timezone=Asia%2FTokyo`;

      const NHK_RSS =
        "https://www.nhk.or.jp/rss/news/cat0.xml";
      const RSS2JSON =
        (rssUrl) => `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;

      const weatherIcons = {
        0: { icon: "‚òÄÔ∏è", label: "Clear" },
        1: { icon: "üå§Ô∏è", label: "Mostly Clear" },
        2: { icon: "‚õÖ", label: "Partly Cloudy" },
        3: { icon: "‚òÅÔ∏è", label: "Overcast" },
        45: { icon: "üå´Ô∏è", label: "Fog" },
        48: { icon: "üå´Ô∏è", label: "Rime Fog" },
        51: { icon: "üå¶Ô∏è", label: "Drizzle" },
        53: { icon: "üå¶Ô∏è", label: "Drizzle" },
        55: { icon: "üåßÔ∏è", label: "Heavy Drizzle" },
        61: { icon: "üåßÔ∏è", label: "Rain" },
        63: { icon: "üåßÔ∏è", label: "Rain" },
        65: { icon: "üåßÔ∏è", label: "Heavy Rain" },
        71: { icon: "‚ùÑÔ∏è", label: "Snow" },
        73: { icon: "‚ùÑÔ∏è", label: "Snow" },
        75: { icon: "‚ùÑÔ∏è", label: "Heavy Snow" },
        80: { icon: "üå¶Ô∏è", label: "Showers" },
        81: { icon: "üå¶Ô∏è", label: "Showers" },
        82: { icon: "üå¶Ô∏è", label: "Heavy Showers" },
        95: { icon: "‚õàÔ∏è", label: "Thunderstorm" },
        96: { icon: "‚õàÔ∏è", label: "Thunderstorm" },
        99: { icon: "‚õàÔ∏è", label: "Thunderstorm" },
      };

      const fallbackNews = [
        {
          title: "„Éá„É¢: ÈÄüÂ†±„Éã„É•„Éº„Çπ„ÅÆË¶ãÂá∫„Åó",
          description: "RSSÂèñÂæó„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØË°®Á§∫„Åß„Åô„ÄÇ",
          pubDate: new Date().toISOString(),
          link: "https://www.nhk.or.jp/",
        },
        {
          title: "„Éá„É¢: „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÂêë„Åë„ÅÆË¶ãÂá∫„Åó",
          description: "„Ç´„Éº„ÉâÂΩ¢Âºè„ÅÆ„Éã„É•„Éº„ÇπË°®Á§∫„ÇíÊÉ≥ÂÆö„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
          pubDate: new Date().toISOString(),
          link: "https://www.nhk.or.jp/",
        },
        {
          title: "„Éá„É¢: Â§©Ê∞ó„ÇÑÂú∞Èúá„Å®ÈÄ£Âãï",
          description: "ÂøÖË¶Å„Å´Âøú„Åò„Å¶Âà•„ÅÆRSS„Å´Â∑Æ„ÅóÊõø„ÅàÂèØËÉΩ„Åß„Åô„ÄÇ",
          pubDate: new Date().toISOString(),
          link: "https://www.nhk.or.jp/",
        },
      ];

      const timeEl = document.getElementById("time");
      const dateEl = document.getElementById("date");
      const timezoneEl = document.getElementById("timezone");
      const locationEl = document.getElementById("location");

      const weatherIconEl = document.getElementById("weather-icon");
      const weatherTempEl = document.getElementById("weather-temp");
      const weatherDescEl = document.getElementById("weather-desc");
      const weatherWindEl = document.getElementById("weather-wind");
      const forecastEl = document.getElementById("forecast");

      const newsListEl = document.getElementById("news-list");

      function formatDateTime(date) {
        return new Intl.DateTimeFormat("ja-JP", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          weekday: "short",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        }).format(date);
      }

      let timeSlots = [];

      function createDigit(initial) {
        const wrap = document.createElement("div");
        wrap.className = "flip-digit";
        const inner = document.createElement("div");
        inner.className = "flip-inner";
        const front = document.createElement("span");
        front.className = "flip-face";
        const back = document.createElement("span");
        back.className = "flip-face flip-back";
        front.textContent = initial;
        back.textContent = initial;
        inner.append(front, back);
        wrap.append(inner);

        inner.addEventListener("transitionend", () => {
          if (inner.classList.contains("flip")) {
            inner.classList.remove("flip");
            front.textContent = back.textContent;
          }
        });

        return { wrap, inner, front, back, value: initial };
      }

      function buildTimeSlots(timeStr) {
        timeEl.innerHTML = "";
        timeSlots = [];
        for (const char of timeStr) {
          if (char === ":") {
            const colon = document.createElement("span");
            colon.textContent = ":";
            colon.className = "text-dim";
            timeEl.append(colon);
            continue;
          }
          const slot = createDigit(char);
          timeSlots.push(slot);
          timeEl.append(slot.wrap);
        }
      }

      function updateFlipTime(timeStr) {
        if (!timeSlots.length) {
          buildTimeSlots(timeStr);
          return;
        }
        let slotIndex = 0;
        for (const char of timeStr) {
          if (char === ":") continue;
          const slot = timeSlots[slotIndex];
          if (slot && slot.value !== char) {
            slot.value = char;
            slot.back.textContent = char;
            slot.inner.classList.remove("flip");
            void slot.inner.offsetWidth;
            slot.inner.classList.add("flip");
          }
          slotIndex += 1;
        }
      }

      function updateClock() {
        const now = new Date();
        const time = new Intl.DateTimeFormat("ja-JP", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        }).format(now);
        const weekday = new Intl.DateTimeFormat("ja-JP", {
          weekday: "short",
        }).format(now);
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const date = `${year}Âπ¥${month}Êúà${day}Êó• (${weekday})`;

        updateFlipTime(time);
        dateEl.textContent = date;
        const zone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        timezoneEl.textContent = zone;
      }

      function toLocalTimeLabel(isoString) {
        const date = new Date(isoString);
        return new Intl.DateTimeFormat("ja-JP", {
          hour: "2-digit",
          minute: "2-digit",
        }).format(date);
      }

      function mapWeather(code) {
        return weatherIcons[code] || { icon: "‚ùî", label: "Unknown" };
      }

      async function fetchWeather() {
        try {
          // Open-Meteo „Åã„ÇâÂ§©Ê∞ó„ÇíÂèñÂæó
          const response = await fetch(WEATHER_ENDPOINT(LOCATION.latitude, LOCATION.longitude));
          if (!response.ok) throw new Error("Weather fetch failed");
          const data = await response.json();

          const current = data.current;
          const mapped = mapWeather(current.weather_code);
          weatherIconEl.textContent = mapped.icon;
          weatherTempEl.textContent = `${Math.round(current.temperature_2m)}¬∞C`;
          weatherDescEl.textContent = mapped.label;
          weatherWindEl.textContent = `${Math.round(current.wind_speed_10m)} km/h`;

          forecastEl.innerHTML = "";
          const times = data.hourly.time;
          const temps = data.hourly.temperature_2m;
          const codes = data.hourly.weather_code;
          const pops = data.hourly.precipitation_probability;

          for (let i = 0; i < times.length && forecastEl.children.length < 4; i += 3) {
            const item = document.createElement("div");
            const w = mapWeather(codes[i]);
            const pop = pops ? `${pops[i]}%` : "--";
            item.className = "flex items-center justify-between bg-black/40 rounded-lg px-3 py-2";
            item.innerHTML = `
              <div>
                <p class="text-dim text-xs">${toLocalTimeLabel(times[i])}</p>
                <p class="text-lg">${w.icon}</p>
              </div>
              <div class="text-right">
                <p class="font-display text-lg">${Math.round(temps[i])}¬∞</p>
                <p class="text-dim text-xs">POP ${pop}</p>
              </div>
            `;
            forecastEl.appendChild(item);
          }

        } catch (error) {
          weatherDescEl.textContent = "Weather unavailable";
        }
      }

      function newsCard(item) {
        const date = item.pubDate ? formatDateTime(new Date(item.pubDate)) : "--";
        const link = item.link || "#";
        return `
          <article class="bg-black/60 rounded-xl p-4 flex flex-col gap-3">
            <div class="flex items-start justify-between gap-3">
              <h3 class="font-display text-lg leading-tight">${item.title}</h3>
            </div>
            <p class="text-dim text-sm max-h-16 overflow-hidden">${item.description || ""}</p>
            <div class="text-xs text-dim flex items-center justify-between">
              <span>${date}</span>
              <a class="text-accent" href="${link}" target="_blank" rel="noopener">Open</a>
            </div>
          </article>
        `;
      }

      async function fetchNews() {
        try {
          // RSS„Çírss2jsonÁµåÁî±„ÅßÂèñÂæóÔºàCORSÂõûÈÅøÔºâ
          const response = await fetch(RSS2JSON(NHK_RSS));
          if (!response.ok) throw new Error("News fetch failed");
          const data = await response.json();
          const items = (data.items || []).slice(0, 6).map((item) => ({
            title: item.title,
            description: item.description?.replace(/<[^>]+>/g, ""),
            pubDate: item.pubDate,
            link: item.link,
          }));
          newsListEl.innerHTML = items.length ? items.map(newsCard).join("") : fallbackNews.map(newsCard).join("");
        } catch (error) {
          newsListEl.innerHTML = fallbackNews.map(newsCard).join("");
        }
      }

      function init() {
        locationEl.textContent = LOCATION.name;
        updateClock();
        setInterval(updateClock, 1000);

        fetchWeather();
        fetchNews();

        // 1ÊôÇÈñì„Åî„Å®„Å´Ëá™ÂãïÊõ¥Êñ∞
        setInterval(fetchWeather, 60 * 60 * 1000);
        setInterval(fetchNews, 30 * 60 * 1000);
      }

      init();
    </script>
  </body>
</html>
